version: 2.1

jobs:
  build_web:
    docker:
      - image: cirrusci/flutter:stable
    steps:
      - checkout

      # Install dependencies
      - run:
          name: Flutter pub get
          command: flutter pub get

      # Build Flutter web
      - run:
          name: Build Flutter Web
          command: flutter build web --release

      # Clean large files >25MB
      - run:
          name: Remove large files
          command: find build/web -type f -size +25M -exec rm -f {} \;

      # Deploy to Repo 2
      # Deploy to Repo 2 step
      - run:
          name: Deploy to Repo 2
          command: |
            cd build/web
            # Delete large or unnecessary files
            find . -name "*.dill*" -delete
            find . -type f -size +25M -delete
            ls -lhR  # debug file sizes
      
            git init
            git remote add origin https://$REPO2_USERNAME:$REPO2_PAT@github.com/yunsocheato/deamhr.git
            git switch -C main  # use the default branch of Repo 2
            git add .
            git commit -m "Deploy Flutter web build"
            git push -f origin main


workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build_web
